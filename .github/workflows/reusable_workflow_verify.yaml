name: Verify (Reusable Workflow)

on:
  workflow_call:
    inputs:
      repository:
        description: 'The repository to checkout, e.g. eclipse-hawkbit/hawkbit'
        type: string
        default: 'eclipse-hawkbit/hawkbit'
      ref:
        description: 'The branch, tag or SHA to checkout, e.g. master'
        type: string
        default: 'master'
      maven_properties:
        type: string
        default: ''
        description: 'Properties to pass to Maven command line, e.g. -Djpa.vendor=hibernate'

permissions:
  contents: read

jobs:
  reusable_workflow_verify:
    runs-on: ubuntu-latest
    # ğŸŒŸ ä¼˜åŒ–ç‚¹ 6: è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢ä»»åŠ¡æ— é™æŒ‚èµ·æµªè´¹é¢åº¦
    timeout-minutes: 20

    services:
      rabbitmq:
        # ğŸŒŸ ä¼˜åŒ–ç‚¹ 1: ä¿æŒä½¿ç”¨äº†è½»é‡çº§ alpine é•œåƒ (Good)
        image: rabbitmq:3-management-alpine
        env:
          RABBITMQ_DEFAULT_VHOST: /
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        ports:
          - 15672:15672
          - 5672:5672

    steps:
      - name: Parameters
        run: |
          echo "Repository: ${{ inputs.repository }}"
          echo "Ref: ${{ inputs.ref }}"
          echo "Maven Properties: ${{ inputs.maven_properties }}"

      - uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          # ğŸŒŸ ä¼˜åŒ–ç‚¹ 8: æ˜¾å¼å£°æ˜æµ…å…‹éš†ï¼Œå‡å°‘ä¸‹è½½æ—¶é—´
          fetch-depth: 1

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 21
          # ğŸŒŸ ä¼˜åŒ–ç‚¹ 2: åˆ©ç”¨ setup-java å†…ç½®ç¼“å­˜ï¼Œåˆ é™¤åç»­é‡å¤çš„ actions/cache æ­¥éª¤
          cache: 'maven'

      # âŒ å·²åˆ é™¤ï¼šé‡å¤çš„ 'Cache local Maven repository' æ­¥éª¤
      # éµå¾ªè§„åˆ™ 1 (æœ€å°åŒ– actions) å’Œ è§„åˆ™ 2 (ä¸è¦ä¸å¿…è¦åœ°å®‰è£…/é…ç½®ä¾èµ–)

      - name: Check file license headers
        # ğŸŒŸ ä¿æŒä¼˜åŒ–: å¿«é€Ÿå¤±è´¥çš„æ£€æŸ¥æ”¾åœ¨æ˜‚è´µçš„æµ‹è¯•ä¹‹å‰ (è§„åˆ™ 5)
        run: mvn license:check -PcheckLicense --batch-mode

      - name: Run tests & javadoc
        # å»ºè®®ï¼šå¦‚æœ Javadoc ç”Ÿæˆå¾ˆæ…¢ä¸”ä¸æ˜¯éªŒè¯å¿…é¡»ï¼Œå»ºè®®ç§»é™¤ javadoc:javadoc
        run: mvn clean verify javadoc:javadoc -DdetectOfflineLinks=false -PgenerateTestReport ${{ inputs.maven_properties }} --batch-mode

      # ğŸŒŸ ä¼˜åŒ–ç‚¹ 9: ä½¿ç”¨ Artifactsã€‚å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œä¸Šä¼ æŠ¥å‘Šä»¥ä¾¿è°ƒè¯•
      - name: Upload Test Reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: '**/target/surefire-reports/'
          retention-days: 5
