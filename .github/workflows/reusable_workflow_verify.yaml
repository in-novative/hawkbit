name: Verify (Reusable Workflow)

on:
  workflow_call:
    inputs:
      repository:
        description: 'The repository to checkout, e.g. eclipse-hawkbit/hawkbit'
        type: string
        default: 'eclipse-hawkbit/hawkbit'
      ref:
        description: 'The branch, tag or SHA to checkout, e.g. master'
        type: string
        default: 'master'
      maven_properties:
        type: string
        default: ''
        description: 'Properties to pass to Maven command line'
      skip_javadoc:
        type: boolean
        default: true  # 默认跳过javadoc
        description: 'Skip generating javadoc in CI builds'
      use_rabbitmq:
        type: boolean
        default: false  # 默认不启动RabbitMQ
        description: 'Only enable RabbitMQ if needed for integration tests'

permissions:
  contents: read

jobs:
  reusable_workflow_verify:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # 适当减少超时，促使优化
    
    # 条件化服务启动 - 仅在需要时启动RabbitMQ
    services: ${{ inputs.use_rabbitmq && (fromJson('{
      "rabbitmq": {
        "image": "rabbitmq:3-management-alpine",
        "env": {
          "RABBITMQ_DEFAULT_VHOST": "/",
          "RABBITMQ_DEFAULT_USER": "guest",
          "RABBITMQ_DEFAULT_PASS": "guest"
        },
        "ports": ["15672:15672", "5672:5672"]
      }
    }')) || null }}

    steps:
      - name: Parameters
        run: |
          echo "Optimized workflow for ${{ inputs.repository }} @ ${{ inputs.ref }}"
          echo "RabbitMQ enabled: ${{ inputs.use_rabbitmq }}"
          echo "Javadoc generation: ${{ !inputs.skip_javadoc }}"

      - uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          fetch-depth: 0  # 保持完整历史，license插件需要（可选优化点）
          sparse-checkout: |
            pom.xml
            **/pom.xml
            src/main/java
            src/test/java
            **/src/main/java
            **/src/test/java

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 21
          cache: 'maven'
          # 关键：指定缓存依赖范围
          cache-dependency-path: '**/pom.xml'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository
            **/target
          # 优化缓存键：使用根pom.xml + 模块pom.xml哈希
          key: ${{ runner.os }}-maven-${{ hashFiles('pom.xml', '**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Single-pass build and test
        run: |
          # 合并所有操作到单个Maven命令
          mvn -B -T 1C \
            clean \
            license:check -PcheckLicense \
            verify \
            ${{ inputs.skip_javadoc == false && 'javadoc:javadoc -DdetectOfflineLinks=false' || '' }} \
            -PgenerateTestReport \
            ${{ inputs.maven_properties }} \
            -DskipITs=${{ !inputs.use_rabbitmq }}  # 根据RabbitMQ开关跳过集成测试
        env:
          MAVEN_OPTS: "-Xmx2048m -XX:+UseG1GC"  # 优化JVM参数

      - name: Upload test reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-reports-${{ github.run_id }}
          path: |
            **/target/surefire-reports/*.xml
            **/target/failsafe-reports/*.xml
            **/target/site/jacoco/jacoco.xml
          retention-days: 7
          if-no-files-found: ignore
